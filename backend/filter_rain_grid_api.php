<?php
// กำหนดพิกัด lat, lon และชื่อที่ต้องการ
$target_points = [
    "16.896017,99.36029" => "SB-15",
    "16.896017,99.443436" => "SB-15",
    "16.896017,99.526566" => "SB-15",
    "16.975548,99.36029" => "SB-15",
    "16.975548,99.443436" => "SB-15",
    "16.975548,99.526566" => "SB-15",
    "16.975548,99.6097" => "SB-15",
    "16.975548,99.69284" => "SB-15",
    "16.975548,99.77597" => "SB-15",
    "16.975548,99.8591" => "SB-15",
    "16.975548,99.942245" => "SB-15",
    "16.975548,100.02538" => "SB-15",
    "16.975548,100.10852" => "SB-15",
    "16.975548,100.19165" => "SB-15",
    "17.055046,99.36029" => "SB-15",
    "17.055046,99.443436" => "SB-15",
    "17.055046,99.526566" => "SB-15",
    "17.055046,99.6097" => "SB-15",
    "17.055046,99.69284" => "SB-15",
    "17.055046,99.77597" => "SB-15",
    "17.055046,99.8591" => "SB-15",
    "17.055046,99.942245" => "SB-15",
    "17.055046,100.02538" => "SB-15",
    "17.055046,100.10852" => "SB-15",
    "17.055046,100.19165" => "SB-15",
    "17.134506,99.36029" => "SB-15",
    "17.134506,99.443436" => "SB-15",
    "17.134506,99.526566" => "SB-15",
    "17.134506,99.6097" => "SB-15",
    "17.134506,99.69284" => "SB-15",
    "17.134506,99.77597" => "SB-15",
    "17.134506,99.8591" => "SB-15",
    "17.134506,99.942245" => "SB-15",
    "17.134506,100.02538" => "SB-15",
    "17.134506,100.10852" => "SB-15",
    "17.213936,99.36029" => "SB-15",
    "17.213936,99.443436" => "SB-15",
    "17.213936,99.526566" => "SB-15",
    "17.213936,99.6097" => "SB-15",
    "17.213936,99.69284" => "SB-15",
    "17.213936,99.77597" => "SB-15",
    "17.213936,99.8591" => "SB-15",
    "17.213936,99.942245" => "SB-15",
    "17.213936,100.02538" => "SB-15",
    "17.293333,99.27716" => "SB-15",
    "17.293333,99.36029" => "SB-15",
    "17.293333,99.443436" => "SB-15",
    "17.293333,99.526566" => "SB-15",
    "17.293333,99.6097" => "SB-15",
    "17.293333,99.69284" => "SB-15",
    "17.293333,99.77597" => "SB-15",
    "17.293333,99.8591" => "SB-15",
    "17.293333,99.942245" => "SB-15",
    "17.293333,100.02538" => "SB-15",
    "17.372688,99.27716" => "SB-15",
    "17.372688,99.36029" => "SB-15",
    "17.372688,99.443436" => "SB-15",
    "17.372688,99.526566" => "SB-15",
    "17.372688,99.6097" => "SB-15",
    "17.372688,99.69284" => "SB-14",
    "17.372688,99.77597" => "SB-14",
    "17.372688,99.8591" => "SB-15",
    "17.372688,99.942245" => "SB-15",
    "17.372688,100.02538" => "SB-15",
    "17.452019,99.27716" => "SB-15",
    "17.452019,99.36029" => "SB-15",
    "17.452019,99.443436" => "SB-14",
    "17.452019,99.526566" => "SB-14",
    "17.452019,99.6097" => "SB-14",
    "17.452019,99.69284" => "SB-14",
    "17.452019,99.77597" => "SB-14",
    "17.452019,99.8591" => "SB-14",
    "17.452019,99.942245" => "SB-15",
    "17.452019,100.02538" => "SB-15",
    "17.531313,99.27716" => "SB-15",
    "17.531313,99.36029" => "SB-15",
    "17.531313,99.443436" => "SB-14",
    "17.531313,99.526566" => "SB-14",
    "17.531313,99.6097" => "SB-14",
    "17.531313,99.69284" => "SB-14",
    "17.531313,99.77597" => "SB-14",
    "17.531313,99.8591" => "SB-14",
    "17.610565,99.27716" => "SB-15",
    "17.610565,99.36029" => "SB-15",
    "17.610565,99.443436" => "SB-13",
    "17.610565,99.526566" => "SB-13",
    "17.610565,99.6097" => "SB-13",
    "17.610565,99.69284" => "SB-13",
    "17.610565,99.77597" => "SB-13",
    "17.610565,99.8591" => "SB-14",
    "17.610565,99.942245" => "SB-14",
    "17.689789,99.36029" => "SB-11",
    "17.689789,99.443436" => "SB-11",
    "17.689789,99.526566" => "SB-13",
    "17.689789,99.6097" => "SB-13",
    "17.689789,99.69284" => "SB-11",
    "17.689789,99.77597" => "SB-13",
    "17.689789,99.8591" => "SB-14",
    "17.689789,99.942245" => "SB-14",
    "17.768982,99.36029" => "SB-11",
    "17.768982,99.443436" => "SB-11",
    "17.768982,99.526566" => "SB-11",
    "17.768982,99.6097" => "SB-11",
    "17.768982,99.69284" => "SB-11",
    "17.768982,99.77597" => "SB-12",
    "17.768982,99.8591" => "SB-12",
    "17.768982,99.942245" => "SB-12",
    "17.84813,99.443436" => "SB-11",
    "17.84813,99.526566" => "SB-11",
    "17.84813,99.6097" => "SB-11",
    "17.84813,99.69284" => "SB-11",
    "17.84813,99.77597" => "SB-12",
    "17.84813,99.8591" => "SB-12",
    "17.84813,99.942245" => "SB-9",
    "17.84813,100.02538" => "SB-9",
    "17.84813,100.10852" => "SB-9",
    "17.927246,99.526566" => "SB-11",
    "17.927246,99.6097" => "SB-11",
    "17.927246,99.69284" => "SB-11",
    "17.927246,99.77597" => "SB-11",
    "17.927246,99.8591" => "SB-11",
    "17.927246,99.942245" => "SB-9",
    "17.927246,100.02538" => "SB-9",
    "17.927246,100.10852" => "SB-9",
    "17.927246,100.19165" => "SB-9",
    "18.006332,99.6097" => "SB-11",
    "18.006332,99.69284" => "SB-11",
    "18.006332,99.77597" => "SB-11",
    "18.006332,99.8591" => "SB-11",
    "18.006332,99.942245" => "SB-9",
    "18.006332,100.02538" => "SB-9",
    "18.006332,100.10852" => "SB-9",
    "18.006332,100.19165" => "SB-9",
    "18.006332,100.27478" => "SB-9",
    "18.006332,100.357925" => "SB-9",
    "18.085373,99.69284" => "SB-11",
    "18.085373,99.77597" => "SB-11",
    "18.085373,99.8591" => "SB-11",
    "18.085373,99.942245" => "SB-9",
    "18.085373,100.02538" => "SB-9",
    "18.085373,100.10852" => "SB-9",
    "18.085373,100.19165" => "SB-9",
    "18.085373,100.27478" => "SB-9",
    "18.085373,100.357925" => "SB-9",
    "18.164383,99.77597" => "SB-11",
    "18.164383,99.8591" => "SB-11",
    "18.164383,99.942245" => "SB-10",
    "18.164383,100.02538" => "SB-9",
    "18.164383,100.10852" => "SB-9",
    "18.164383,100.19165" => "SB-9",
    "18.164383,100.27478" => "SB-9",
    "18.164383,100.357925" => "SB-9",
    "18.164383,100.44106" => "SB-9",
    "18.243362,99.8591" => "SB-10",
    "18.243362,99.942245" => "SB-10",
    "18.243362,100.02538" => "SB-10",
    "18.243362,100.10852" => "SB-9",
    "18.243362,100.19165" => "SB-7",
    "18.243362,100.27478" => "SB-8",
    "18.243362,100.357925" => "SB-9",
    "18.243362,100.44106" => "SB-9",
    "18.322304,99.942245" => "SB-10",
    "18.322304,100.02538" => "SB-10",
    "18.322304,100.10852" => "SB-7",
    "18.322304,100.19165" => "SB-7",
    "18.322304,100.27478" => "SB-7",
    "18.322304,100.357925" => "SB-8",
    "18.322304,100.44106" => "SB-8",
    "18.4012,99.942245" => "SB-6",
    "18.4012,100.02538" => "SB-6",
    "18.4012,100.10852" => "SB-7",
    "18.4012,100.19165" => "SB-7",
    "18.4012,100.27478" => "SB-7",
    "18.4012,100.357925" => "SB-7",
    "18.4012,100.44106" => "SB-8",
    "18.4012,100.5242" => "SB-8",
    "18.952509,99.942245" => "SB-6",
    "18.952509,100.10852" => "SB-3",
    "18.952509,100.19165" => "SB-3",
    "18.952509,100.27478" => "SB-3",
    "18.952509,100.357925" => "SB-4",
    "18.952509,100.44106" => "SB-4",
    "18.952509,100.5242" => "SB-4",
    "19.03112,99.77597" => "SB-6",
    "19.03112,99.8591" => "SB-6",
    "19.03112,100.10852" => "SB-3",
    "19.03112,100.19165" => "SB-3",
    "19.03112,100.27478" => "SB-3",
    "19.03112,100.357925" => "SB-2",
    "19.03112,100.44106" => "SB-2",
    "19.03112,100.5242" => "SB-2",
    "19.03112,100.60733" => "SB-2",
    "19.109695,100.10852" => "SB-3",
    "19.109695,100.19165" => "SB-3",
    "19.109695,100.27478" => "SB-3",
    "19.109695,100.357925" => "SB-2",
    "19.109695,100.44106" => "SB-2",
    "19.109695,100.5242" => "SB-2",
    "19.109695,100.60733" => "SB-2",
    "19.109695,100.69046" => "SB-2",
    "19.188232,100.10852" => "SB-3",
    "19.188232,100.19165" => "SB-3",
    "19.188232,100.27478" => "SB-1",
    "19.188232,100.357925" => "SB-1",
    "19.188232,100.44106" => "SB-2",
    "19.188232,100.5242" => "SB-2",
    "19.188232,100.60733" => "SB-2",
    "19.266724,100.27478" => "SB-1",
    "19.266724,100.357925" => "SB-1",
    "19.266724,100.44106" => "SB-1",
    "19.266724,100.5242" => "SB-2",
    "19.266724,100.60733" => "SB-2",
    "19.345192,100.27478" => "SB-1",
    "19.345192,100.357925" => "SB-1",
    "19.345192,100.44106" => "SB-1",
    "19.345192,100.5242" => "SB-1",
    "19.345192,100.60733" => "SB-2",
    "19.423615,100.44106" => "SB-1",
    "19.423615,100.5242" => "SB-1"
];
function find_file_by_date($base_dir, $date, $prefix = "p24h.d01.") {
    $time_slots = ["18", "12", "06", "00"]; // ช่วงเวลาที่ต้องการไล่หา
    foreach ($time_slots as $slot) {
        $filename = $base_dir . $prefix . $date . $slot . ".csv";
        if (file_exists($filename)) {
            return $filename; // หากพบไฟล์ ให้คืนค่าชื่อไฟล์
        }
    }
    return false; // หากไม่พบไฟล์
}

// กำหนดวันปัจจุบันในรูปแบบ YYYYMMDD
$current_date = date("Ymd");

// กำหนดที่อยู่ของไฟล์ที่ต้องการตรวจสอบ
$base_dir = "./rain_grid/";

// ค้นหาไฟล์ที่มีชื่อจากวันที่ปัจจุบัน
$filename = find_file_by_date($base_dir, $current_date);

if (!$filename) {
    // ลองย้อนหาวันที่ย้อนหลัง 3 วัน
    for ($i = 1; $i <= 3; $i++) {
        $prev_date = date("Ymd", strtotime("-{$i} day", strtotime($current_date)));
        $filename = find_file_by_date($base_dir, $prev_date);
        
        if ($filename) {
            break; // เจอไฟล์แล้ว ออกจากลูป
        }
    }
}

if (!$filename) {
    echo json_encode(["error" => "ไม่พบไฟล์ย้อนหลัง 3 วัน"]);
    exit;
}

// ถ้าพบไฟล์แล้ว ให้ทำการโหลดไฟล์ CSV
$data = [];
$headers = [];
$count_data = []; // ใช้นับจำนวนข้อมูลแต่ละคอลัมน์
if (($handle = fopen($filename, "r")) !== false) {
    while (($row = fgetcsv($handle)) !== false) {
        if (empty($headers)) {
            // ดึงหัวข้อคอลัมน์
            $headers = $row;
            continue;
        }

        // จับคู่ข้อมูลตามหัวข้อคอลัมน์
        $row_assoc = array_combine($headers, $row);
        $lat_lon = $row_assoc["lat"] . "," . $row_assoc["lon"];

        // ตรวจสอบว่าพิกัดอยู่ในรายการที่กำหนดหรือไม่
        if (isset($target_points[$lat_lon])) {
            $name = $target_points[$lat_lon];

            // รวมข้อมูลตามชื่อสถานีและวันที่
            foreach ($row_assoc as $key_column => $value) {
                if ($key_column != "lat" && $key_column != "lon") {
                    $date = $key_column;  // วันที่จากชื่อคอลัมน์
                    // ตรวจสอบว่าเป็นตัวเลขก่อนที่จะรวมค่า
                    $float_value = is_numeric($value) ? floatval($value) : 0;

                    // สร้างคีย์ที่ประกอบด้วยสถานีและวันที่
                    $key = $name;
                    if (!isset($data[$key])) {
                        $data[$key] = [
                            "values" => []
                        ];
                        $count_data[$key] = [];
                    }

                    // เพิ่มค่าผลรวม
                    if (!isset($data[$key]["values"][$key_column])) {
                        $data[$key]["values"][$key_column] = 0;
                        $count_data[$key][$key_column] = 0;
                    }
                    $data[$key]["values"][$key_column] += $float_value;
                    $count_data[$key][$key_column]++; // เพิ่มจำนวนข้อมูลที่ใช้รวมค่า
                }
            }
        }
    }
    fclose($handle);
}

// คำนวณค่าเฉลี่ยโดยการหารค่าผลรวมด้วยจำนวนข้อมูลที่ใช้รวมค่า
foreach ($data as $key => &$station) {
    foreach ($station["values"] as $date => &$value) {
        if ($count_data[$key][$date] > 0) {
            $value = $value / $count_data[$key][$date]; // คำนวณค่าเฉลี่ย
        }
    }
}

// สร้าง JSON เป็นผลลัพธ์
header('Content-Type: application/json');
echo json_encode($data, JSON_PRETTY_PRINT);
?>

